name: ğŸ”§ Setup Environment

on:
  # Se ejecuta manualmente
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno a configurar'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      python_version:
        description: 'VersiÃ³n de Python'
        required: true
        default: '3.11'
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
  
  # Se ejecuta cuando se hace push a ramas especÃ­ficas
  push:
    branches: [ main, develop ]
    paths:
      - 'requirements*.txt'
      - 'project/settings/**'
      - '.github/workflows/setup-environment.yml'

  # Se ejecuta en pull requests que modifican archivos de configuraciÃ³n
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'requirements*.txt'
      - 'project/settings/**'
      - '.github/workflows/setup-environment.yml'

jobs:
  setup-environment:
    name: ğŸ”§ Setup Environment (${{ github.event.inputs.environment || 'auto' }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ” Verificar estructura del proyecto
        run: |
          echo "ğŸ” Verificando estructura del proyecto..."
          
          # Verificar archivos esenciales
          test -f manage.py || (echo "âŒ manage.py no encontrado" && exit 1)
          test -f requirements.txt || (echo "âŒ requirements.txt no encontrado" && exit 1)
          test -f requirements-dev.txt || (echo "âŒ requirements-dev.txt no encontrado" && exit 1)
          test -d project/settings || (echo "âŒ project/settings/ no encontrado" && exit 1)
          
          # Verificar apps de Django
          test -d tournaments || (echo "âŒ tournaments app no encontrada" && exit 1)
          test -d teams || (echo "âŒ teams app no encontrada" && exit 1)
          test -d matches || (echo "âŒ matches app no encontrada" && exit 1)
          test -d events || (echo "âŒ events app no encontrada" && exit 1)
          
          echo "âœ… Estructura del proyecto verificada"

      - name: ğŸ Crear entorno virtual
        run: |
          echo "ğŸ Creando entorno virtual..."
          python -m venv venv
          source venv/bin/activate
          
          # Actualizar pip
          pip install --upgrade pip
          
          echo "âœ… Entorno virtual creado exitosamente"

      - name: ğŸ“¦ Instalar dependencias de producciÃ³n
        run: |
          echo "ğŸ“¦ Instalando dependencias de producciÃ³n..."
          source venv/bin/activate
          pip install -r requirements.txt
          echo "âœ… Dependencias de producciÃ³n instaladas"

      - name: ğŸ› ï¸ Instalar dependencias de desarrollo
        run: |
          echo "ğŸ› ï¸ Instalando dependencias de desarrollo..."
          source venv/bin/activate
          pip install -r requirements-dev.txt
          echo "âœ… Dependencias de desarrollo instaladas"

      - name: ğŸ”§ Configurar variables de entorno
        run: |
          echo "ğŸ”§ Configurando variables de entorno..."
          
          # Crear .env desde plantilla si no existe
          test -f .env || cp env.example .env
          
          # Configurar variables segÃºn el entorno
          ENVIRONMENT="${{ github.event.inputs.environment || 'development' }}"
          
          case $ENVIRONMENT in
            "development")
              echo "ğŸ”¹ Configurando para desarrollo..."
              sed -i 's/^DEBUG=.*/DEBUG=True/' .env
              sed -i 's/^DB_NAME=.*/DB_NAME=donbosco_cup_dev/' .env
              ;;
            "staging")
              echo "ğŸ”¹ Configurando para staging..."
              sed -i 's/^DEBUG=.*/DEBUG=False/' .env
              sed -i 's/^DB_NAME=.*/DB_NAME=donbosco_cup_staging/' .env
              ;;
            "production")
              echo "ğŸ”¹ Configurando para producciÃ³n..."
              sed -i 's/^DEBUG=.*/DEBUG=False/' .env
              sed -i 's/^DB_NAME=.*/DB_NAME=donbosco_cup_prod/' .env
              ;;
          esac
          
          # Mostrar configuraciÃ³n completa (sin passwords sensibles)
          echo "=== CONFIGURACIÃ“N ACTUAL ==="
          echo "ğŸ“‹ Variables no sensibles:"
          grep -v "PASSWORD\|SECRET" .env | head -15
          echo ""
          echo "ğŸ“‹ Estructura del archivo .env:"
          echo "Total de lÃ­neas: $(wc -l < .env)"
          echo "Variables configuradas: $(grep -c '=' .env)"
          echo ""
          echo "ğŸ“‹ Variables principales:"
          grep -E '^(DEBUG|DB_NAME|DB_HOST|DB_PORT|ALLOWED_HOSTS|CORS_)' .env || echo "No se encontraron variables principales"

      - name: ğŸ—„ï¸ Setup PostgreSQL
        run: |
          echo "ğŸ—„ï¸ Configurando PostgreSQL..."
          
          # Instalar PostgreSQL
          sudo systemctl start postgresql || true
          sudo systemctl enable postgresql || true
          
          # Crear base de datos de prueba
          sudo -u postgres psql -c "CREATE DATABASE test_db;" || echo "Base de datos test_db ya existe"
          sudo -u postgres psql -c "CREATE USER test_user WITH PASSWORD 'test_pass';" || echo "Usuario test_user ya existe"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE test_db TO test_user;" || echo "Privilegios ya otorgados"
          
          echo "âœ… PostgreSQL configurado"

      - name: ğŸ§ª Verificar configuraciÃ³n de Django
        run: |
          echo "ğŸ§ª Verificando configuraciÃ³n de Django..."
          source venv/bin/activate
          
          # Verificar que Django puede cargar las configuraciones
          python -c "
          import os
          os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'project.settings.dev')
          import django
          django.setup()
          from django.conf import settings
          print(f'âœ… Django configurado correctamente')
          print(f'ğŸ“Š Base de datos: {settings.DATABASES[\"default\"][\"ENGINE\"]}')
          print(f'ğŸ”§ Debug: {settings.DEBUG}')
          print(f'ğŸŒ Apps instaladas: {len(settings.INSTALLED_APPS)}')
          "

      - name: ğŸ” Verificar instalaciÃ³n de herramientas
        run: |
          echo "ğŸ” Verificando herramientas instaladas..."
          source venv/bin/activate
          
          # Verificar herramientas de calidad de cÃ³digo
          black --version && echo "âœ… Black instalado"
          isort --version && echo "âœ… isort instalado"
          flake8 --version && echo "âœ… Flake8 instalado"
          mypy --version && echo "âœ… MyPy instalado"
          safety --version && echo "âœ… Safety instalado"
          bandit --version && echo "âœ… Bandit instalado"
          
          echo "âœ… Todas las herramientas verificadas"

      - name: ğŸ“Š Generar reporte de entorno
        run: |
          echo "ğŸ“Š Generando reporte de entorno..."
          source venv/bin/activate
          
          echo "=== REPORTE DE ENTORNO ==="
          echo "ğŸ Python: $(python --version)"
          echo "ğŸ“¦ Pip: $(pip --version | cut -d' ' -f2)"
          echo "ğŸ”§ Django: $(python -c 'import django; print(django.get_version())')"
          echo "ğŸ—„ï¸ PostgreSQL: $(psql --version | cut -d' ' -f3)"
          echo "ğŸ“ Directorio de trabajo: $(pwd)"
          echo "ğŸŒ¿ Entorno virtual: $(which python)"
          
          echo ""
          echo "=== DEPENDENCIAS INSTALADAS ==="
          pip list | grep -E "(Django|psycopg2|black|isort|flake8|mypy|safety|bandit)" || echo "No se encontraron dependencias principales"
      

      - name: ğŸ’¾ Guardar artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: environment-setup-report-${{ github.event.inputs.environment || 'development' }}
          path: |
            .env
            requirements.txt
            requirements-dev.txt
          retention-days: 7

      - name: ğŸ“ Comentario en PR (si es PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ”§ Setup Environment')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: `## ğŸ”§ Setup Environment - Completado âœ…
                
                **Entorno configurado exitosamente:**
                - âœ… Python ${{ matrix.python-version }}
                - âœ… Dependencias instaladas
                - âœ… PostgreSQL configurado
                - âœ… Variables de entorno configuradas
                - âœ… Django verificado
                
                **PrÃ³ximos pasos:**
                1. Ejecutar migraciones: \`python manage.py migrate\`
                2. Crear superusuario: \`python manage.py createsuperuser\`
                3. Ejecutar servidor: \`python manage.py runserver\`
                
                **Comando para configurar localmente:**
                \`\`\`bash
                python -m venv venv
                source venv/bin/activate
                pip install -r requirements.txt
                pip install -r requirements-dev.txt
                cp env.example .env
                # Editar .env con tus configuraciones
                \`\`\``
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ğŸ”§ Setup Environment - Completado âœ…
                
                **Entorno configurado exitosamente:**
                - âœ… Python ${{ matrix.python-version }}
                - âœ… Dependencias instaladas
                - âœ… PostgreSQL configurado
                - âœ… Variables de entorno configuradas
                - âœ… Django verificado
                
                **PrÃ³ximos pasos:**
                1. Ejecutar migraciones: \`python manage.py migrate\`
                2. Crear superusuario: \`python manage.py createsuperuser\`
                3. Ejecutar servidor: \`python manage.py runserver\`
                
                **Comando para configurar localmente:**
                \`\`\`bash
                python -m venv venv
                source venv/bin/activate
                pip install -r requirements.txt
                pip install -r requirements-dev.txt
                cp env.example .env
                # Editar .env con tus configuraciones
                \`\`\``
              });
            }
