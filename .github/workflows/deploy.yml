name: Deployment to Main

on:
  workflow_dispatch:

jobs:
  deploy-project:
    runs-on: ubuntu-latest

    steps:
      - name: Configurar SSH
        run: |
          echo "ğŸ”¹ Creando la clave privada..."
          echo "${{ secrets.SSH_MAIN }}" > private_key
          chmod 600 private_key 
          
          echo "ğŸ”¹ Iniciando ssh-agent..."
          eval "$(ssh-agent -s)"
          
          export SSH_ASKPASS=/bin/echo
          echo "ğŸ”¹ Agregando clave SSH con passphrase..."
          echo "${{ secrets.SSH_PASSPHRASE }}" | setsid ssh-add private_key
          
          echo "ğŸ”¹ Configurando ~/.ssh/config..."
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
           
          echo "âœ… ConfiguraciÃ³n SSH completada"

      - name: Conectar al servidor y desplegar Laravel
        run: |
          echo "ğŸ”¹ Verificando existencia de private_key..."
          ls -l private_key || { echo "âš ï¸ ERROR: private_key no encontrado"; exit 1; }
          
          echo "ğŸ”¹ Iniciando ssh-agent..."
          eval "$(ssh-agent -s)"
          
          echo "ğŸ”¹ Agregando clave privada al ssh-agent con passphrase..."
          echo "${{ secrets.SSH_PASSPHRASE }}" | ssh-add private_key 
          
          echo "ğŸ”¹ Conectando al servidor y ejecutando despliegue..."
          ssh -tt -A -i private_key -o StrictHostKeyChecking=no salesiano-ssh@137.184.135.155 << "EOF"
            echo "âœ… Conectado al servidor"
            cd ~/htdocs/salesiano.altocodigo.com || exit 1

            if [ ! -f .env ]; then
              echo "ğŸ”¹ Preparando despliegue sin eliminar contenido existente..."

              echo "ğŸ”¹ Clonando el repositorio en carpeta temporal..."
              git clone https://${{ secrets.PAT_TOKEN }}@github.com/OtherCde/project-donbosco-cup.git || exit 1

              echo "ğŸ”¹ Cambiando a la rama main"
              cd project-donbosco-cup || exit 1
              git checkout main

              echo "ğŸ”¹ Actualizando repositorio..."
              git pull origin main

              echo "ğŸ”¹ Moviendo archivos a la carpeta actual..."
              shopt -s dotglob
              mv * ../
              cd ..
              rm -rf project-donbosco-cup
              
              echo "âœ… Despliegue completado"
            else
              echo "ğŸ”¹ El repositorio ya existe. Usa el workflow de actualizaciÃ³n."
            fi

            exit
          EOF